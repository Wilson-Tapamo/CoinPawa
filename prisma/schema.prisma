// Fichier: prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Pour les migrations avec Neon
}

// --- 1. ENUMS (Les types fixes) ---

enum TxType {
  DEPOSIT
  DEPOSIT_BONUS  // ‚Üê Ajouter cette ligne
  WITHDRAW
  BET
  WIN
}

enum TxStatus {
  PENDING
  COMPLETED
  FAILED
  EXPIRED   // üÜï Pour les paiements crypto expir√©s
}

enum GameType {
  LOTTERY   // Tirage journalier
  INSTANT   // Dice, Wheel
  SESSION   // Blackjack, Mines
}

enum RoundStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

// --- 2. MOD√àLES ---

model User {
  id           String   @id @default(uuid())
  
  // Auth Hybride : Optionnels pour permettre le mode "Anonyme" au d√©part
  username     String  @unique
  email        String?  @unique
  passwordHash String 
  
  // Syst√®me de Parrainage
  referrerId   String?
  referrer     User?    @relation("ReferralHistory", fields: [referrerId], references: [id])
  referrals    User[]   @relation("ReferralHistory")
  
  referralEarningsSats BigInt @default(0)

  // Relation
  wallet       Wallet?  // Relation 1-1

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Wallet {
  id              String   @id @default(uuid())
  
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  
  balanceSats     BigInt   @default(0) 
  
  // Wager Requirement (Valid√© par ton Chef de Projet)
  // R√®gle : totalWagered doit √™tre >= totalDeposited pour retirer
  totalDepositedSats BigInt @default(0)
  totalWageredSats   BigInt @default(0)
  
  lastFaucetClaim DateTime?

  // üÜï CRYPTO PAYMENT FIELDS
  // Adresse de retrait pr√©f√©r√©e de l'utilisateur (USDT)
  withdrawalAddress String?
  // R√©seau pr√©f√©r√© pour les retraits (TRC20, ERC20, BEP20, etc.)
  withdrawalNetwork String? @default("TRC20")

  transactions    Transaction[]
  gameRounds      GameRound[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Transaction {
  id          String   @id @default(uuid())
  
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  
  type        TxType
  amountSats  BigInt   // Montant final cr√©dit√©/d√©bit√© en sats
  
  paymentRef  String   @unique // R√©f√©rence unique (order_id pour NOWPayments)
  status      TxStatus @default(PENDING)
  
  // üÜï MULTI-CRYPTO FIELDS (pour les d√©p√¥ts)
  cryptoCurrency   String?  // BTC, ETH, USDC, SOL, BNB, etc.
  cryptoAmount     String?  // Montant que l'user a envoy√© dans sa crypto
  usdtAmount       String?  // Montant apr√®s conversion en USDT
  exchangeRate     String?  // Taux de conversion appliqu√© (cryptoAmount / usdtAmount)
  
  // üÜï BLOCKCHAIN DATA
  txHash           String?  @unique // Hash de la transaction blockchain (si applicable)
  fromAddress      String?  // Adresse source (pour DEPOSIT)
  toAddress        String?  // Adresse destination (pour WITHDRAW)
  blockNumber      Int?     // Num√©ro de bloc (confirmation)
  confirmations    Int?     @default(0) // Nombre de confirmations
  
  // üÜï NOWPAYMENTS INTEGRATION
  nowPaymentId     String?  @unique  // ID du paiement NOWPayments
  paymentUrl       String?  // URL/adresse de paiement g√©n√©r√©e
  paymentExpiry    DateTime? // Date d'expiration du paiement
  
  // üÜï WITHDRAWAL FIELDS
  withdrawalFee    BigInt?  // Frais de retrait en sats
  netAmount        BigInt?  // Montant net re√ßu (amountSats - withdrawalFee)
  
  // M√©tadonn√©es additionnelles
  metadata         Json?    // Pour stocker des infos suppl√©mentaires (IP, user agent, etc.)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // üÜï INDEX pour optimiser les requ√™tes
  @@index([walletId])
  @@index([status])
  @@index([type])
  @@index([nowPaymentId])
  @@index([createdAt])
}

model Game {
  id          String   @id @default(uuid())
  
  slug        String   @unique // ex: "dice", "mines"
  name        String
  type        GameType
  isActive    Boolean  @default(true)
  
  // UX / Marketing (Description des jeux)
  shortDesc   String?
  rules       String?  @db.Text // Support du Markdown long
  imageUrl    String?
  
  // Config Technique
  config      Json?    // ex: { "houseEdge": 1.0 }
  maxWinSats  BigInt?  // S√©curit√© Bankroll

  rounds      GameRound[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model GameRound {
  id          String   @id @default(uuid())
  
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  
  gameId      String
  game        Game     @relation(fields: [gameId], references: [id])
  
  status      RoundStatus @default(ACTIVE)

  // Finances de la partie
  betAmountSats    BigInt
  payoutAmountSats BigInt @default(0)
  
  // √âtat du jeu (JSON flexible selon le jeu)
  gameData    Json 

  // Provably Fair
  clientSeed     String
  serverSeedHash String
  serverSeed     String?
  nonce          Int

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Index pour la performance des historiques
  @@index([walletId])
  @@index([gameId])
}

// üÜï NOUVEAU MOD√àLE : Configuration des cryptos accept√©es
model SupportedCrypto {
  id              String   @id @default(uuid())
  
  symbol          String   @unique // BTC, ETH, USDC, SOL, BNB, etc.
  name            String   // Bitcoin, Ethereum, USD Coin, etc.
  network         String?  // ethereum, solana, binance-smart-chain, etc.
  isActive        Boolean  @default(true)
  
  // Configuration
  minDepositUsd   Float    @default(5.0)   // Montant minimum de d√©p√¥t en USD
  icon            String?  // URL de l'ic√¥ne ou emoji
  orderIndex      Int      @default(0)     // Pour trier l'affichage
  
  // Stats (optionnel)
  totalDeposits   Int      @default(0)
  totalVolume     Float    @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([isActive, orderIndex])
}

// üÜï NOUVEAU MOD√àLE : Param√®tres syst√®me pour le paiement
model PaymentSettings {
  id              String   @id @default(uuid())
  
  key             String   @unique // ex: "min_deposit_usd", "withdrawal_fee_percent"
  value           String   // Valeur en JSON ou string
  description     String?
  
  updatedAt       DateTime @updatedAt
}
