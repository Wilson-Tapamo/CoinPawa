// Fichier: prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Pour les migrations avec Neon
}

// --- 1. ENUMS (Les types fixes) ---

enum TxType {
  DEPOSIT
  DEPOSIT_BONUS
  WITHDRAW
  BET
  WIN
}

enum TxStatus {
  PENDING
  COMPLETED
  FAILED
  EXPIRED
  CANCELLED  // ðŸ†• Pour les transactions annulÃ©es par admin
}

enum GameType {
  LOTTERY
  INSTANT
  SESSION
}

enum RoundStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

// ðŸ†• ENUMS ADMIN
enum UserRole {
  USER
  MODERATOR
  ADMIN
  SUPER_ADMIN
}

enum AdminActionType {
  BAN_USER
  UNBAN_USER
  APPROVE_WITHDRAWAL
  REJECT_WITHDRAWAL
  ADJUST_BALANCE
  EDIT_USER
  DELETE_TRANSACTION
  CHANGE_GAME_STATUS
  UPDATE_SETTINGS
  VIEW_SENSITIVE_DATA
}

// --- 2. MODÃˆLES ---

model User {
  id           String   @id @default(uuid())
  
  // Auth
  username     String   @unique
  email        String?  @unique
  passwordHash String 
  
  // ðŸ†• ADMIN & MODÃ‰RATION
  role         UserRole @default(USER)
  isBanned     Boolean  @default(false)
  bannedAt     DateTime?
  banReason    String?  @db.Text
  bannedBy     String?  // ID de l'admin qui a banni
  
  // ðŸ†• KYC / VERIFICATION
  isEmailVerified Boolean @default(false)
  emailVerifiedAt DateTime?
  kycLevel        Int     @default(0) // 0 = None, 1 = Basic, 2 = Full
  kycData         Json?   // Documents, status, etc.
  
  // ðŸ†• SÃ‰CURITÃ‰
  lastLoginAt     DateTime?
  lastLoginIp     String?
  failedLoginAttempts Int @default(0)
  lockedUntil     DateTime?
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?
  
  // SystÃ¨me de Parrainage
  referrerId   String?
  referrer     User?    @relation("ReferralHistory", fields: [referrerId], references: [id])
  referrals    User[]   @relation("ReferralHistory")
  referralEarningsSats BigInt @default(0)
  
  // ðŸ†• STATS UTILISATEUR
  totalDeposited   BigInt @default(0)
  totalWithdrawn   BigInt @default(0)
  totalWagered     BigInt @default(0)
  totalWon         BigInt @default(0)
  gamesPlayed      Int    @default(0)
  
  // Relations
  wallet           Wallet?
  adminActions     AdminAction[] @relation("PerformedActions")
  targetedActions  AdminAction[] @relation("TargetedUser")
  notes            AdminNote[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // ðŸ†• INDEX
  @@index([role])
  @@index([isBanned])
  @@index([email])
  @@index([createdAt])
}

model Wallet {
  id              String   @id @default(uuid())
  
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  balanceSats     BigInt   @default(0) 
  
  // Wager Requirement
  totalDepositedSats BigInt @default(0)
  totalWageredSats   BigInt @default(0)
  
  lastFaucetClaim DateTime?
  
  // CRYPTO PAYMENT
  withdrawalAddress String?
  withdrawalNetwork String? @default("TRC20")
  
  // ðŸ†• LIMITES & RESTRICTIONS
  dailyWithdrawLimit  BigInt?  // Limite quotidienne de retrait
  monthlyWithdrawLimit BigInt? // Limite mensuelle
  isWithdrawLocked    Boolean @default(false)
  withdrawLockReason  String?
  
  transactions    Transaction[]
  gameRounds      GameRound[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Transaction {
  id          String   @id @default(uuid())
  
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  type        TxType
  amountSats  BigInt
  
  paymentRef  String   @unique
  status      TxStatus @default(PENDING)
  
  // MULTI-CRYPTO
  cryptoCurrency   String?
  cryptoAmount     String?
  usdtAmount       String?
  exchangeRate     String?
  
  // BLOCKCHAIN DATA
  txHash           String?  @unique
  fromAddress      String?
  toAddress        String?
  blockNumber      Int?
  confirmations    Int?     @default(0)
  
  // NOWPAYMENTS
  nowPaymentId     String?  @unique
  paymentUrl       String?
  paymentExpiry    DateTime?
  
  // WITHDRAWAL
  withdrawalFee    BigInt?
  netAmount        BigInt?
  
  // ðŸ†• ADMIN & VALIDATION
  approvedBy       String?  // ID de l'admin qui a approuvÃ©
  approvedAt       DateTime?
  rejectedBy       String?
  rejectedAt       DateTime?
  rejectionReason  String?  @db.Text
  
  // ðŸ†• FRAUD DETECTION
  riskScore        Float?   @default(0)
  isFlagged        Boolean  @default(false)
  flagReason       String?
  reviewedBy       String?
  reviewedAt       DateTime?
  
  // ðŸ†• TRACKING
  userIp           String?
  userAgent        String?
  
  metadata         Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([walletId])
  @@index([status])
  @@index([type])
  @@index([nowPaymentId])
  @@index([createdAt])
  @@index([isFlagged])
  @@index([approvedBy])
}

model Game {
  id          String   @id @default(uuid())
  
  slug        String   @unique
  name        String
  type        GameType
  isActive    Boolean  @default(true)
  
  // UX
  shortDesc   String?
  rules       String?  @db.Text
  imageUrl    String?
  
  // Config
  config      Json?
  maxWinSats  BigInt?
  
  // ðŸ†• ADMIN & STATS
  createdBy   String?  // ID de l'admin crÃ©ateur
  houseEdge   Float    @default(2.0) // House edge en %
  
  // ðŸ†• STATISTICS
  totalBets   Int      @default(0)
  totalWagered BigInt  @default(0)
  totalPayout  BigInt  @default(0)
  playCount    Int     @default(0)
  
  rounds      GameRound[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive])
  @@index([type])
}

model GameRound {
  id          String   @id @default(uuid())
  
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  gameId      String
  game        Game     @relation(fields: [gameId], references: [id])
  
  status      RoundStatus @default(ACTIVE)
  
  betAmountSats    BigInt
  payoutAmountSats BigInt @default(0)
  
  gameData    Json 
  
  // Provably Fair
  clientSeed     String
  serverSeedHash String
  serverSeed     String?
  nonce          Int
  
  // ðŸ†• FRAUD DETECTION
  isSuspicious   Boolean @default(false)
  suspicionReason String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([walletId])
  @@index([gameId])
  @@index([createdAt])
  @@index([isSuspicious])
}

model SupportedCrypto {
  id              String   @id @default(uuid())
  
  symbol          String   @unique
  name            String
  network         String?
  isActive        Boolean  @default(true)
  
  minDepositUsd   Float    @default(5.0)
  icon            String?
  orderIndex      Int      @default(0)
  
  // Stats
  totalDeposits   Int      @default(0)
  totalVolume     Float    @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([isActive, orderIndex])
}

model PaymentSettings {
  id              String   @id @default(uuid())
  
  key             String   @unique
  value           String
  description     String?
  
  updatedAt       DateTime @updatedAt
}

// ðŸ†• MODÃˆLES ADMIN

// Log de toutes les actions admin
model AdminAction {
  id          String   @id @default(uuid())
  
  adminId     String
  admin       User     @relation("PerformedActions", fields: [adminId], references: [id])
  
  action      AdminActionType
  
  // Cible de l'action (optionnel)
  targetUserId    String?
  targetUser      User?   @relation("TargetedUser", fields: [targetUserId], references: [id])
  
  targetEntityType String? // "Transaction", "Game", "Settings", etc.
  targetEntityId   String? // ID de l'entitÃ©
  
  // DÃ©tails
  details     Json?    // DonnÃ©es avant/aprÃ¨s, raison, etc.
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  @@index([adminId])
  @@index([targetUserId])
  @@index([action])
  @@index([createdAt])
}

// Notes admin sur les utilisateurs
model AdminNote {
  id          String   @id @default(uuid())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  authorId    String   // ID de l'admin qui a Ã©crit la note
  authorName  String   // Nom de l'admin (pour historique)
  
  note        String   @db.Text
  isImportant Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([isImportant])
}

// Configuration globale du systÃ¨me
model SystemConfig {
  id          String   @id @default(uuid())
  
  key         String   @unique
  value       Json
  category    String   // "payment", "game", "security", etc.
  description String?  @db.Text
  isPublic    Boolean  @default(false) // Visible aux non-admins ?
  
  lastModifiedBy String? // ID de l'admin
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
}

// Alertes systÃ¨me pour les admins
model SystemAlert {
  id          String   @id @default(uuid())
  
  type        String   // "withdrawal_pending", "suspicious_activity", etc.
  severity    String   // "low", "medium", "high", "critical"
  title       String
  message     String   @db.Text
  
  data        Json?    // DonnÃ©es contextuelles
  
  isRead      Boolean  @default(false)
  readBy      String?  // ID de l'admin
  readAt      DateTime?
  
  isResolved  Boolean  @default(false)
  resolvedBy  String?
  resolvedAt  DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([isRead])
  @@index([isResolved])
  @@index([severity])
  @@index([createdAt])
}

// Stats journaliÃ¨res pour les graphiques
model DailyStats {
  id              String   @id @default(uuid())
  
  date            DateTime @unique @db.Date
  
  // Users
  newUsers        Int      @default(0)
  activeUsers     Int      @default(0)
  
  // Finances
  totalDeposits   BigInt   @default(0)
  totalWithdrawals BigInt  @default(0)
  totalBets       BigInt   @default(0)
  totalWins       BigInt   @default(0)
  revenue         BigInt   @default(0)
  
  // Games
  gamesPlayed     Int      @default(0)
  uniquePlayers   Int      @default(0)
  
  // Calculated
  houseEdge       Float    @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([date])
}
